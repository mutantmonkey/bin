#!/bin/sh

attach=0
xpra_host="$1"
xpra_display=10
conn_str="ssh/${xpra_host}/${xpra_display}"

systemctl --user start appvm-ssh@${xpra_host}.service

xpra attach "${conn_str}" \
    --encoding=rgb \
    --title="@title@ on ${xpra_host}" \
    --tray=no \
    --notifications=no \
    --username=user \
    --desktop-scaling=no

if [[ $? != 0 ]]; then
    shift 1
    app="${@:-firefox}"

    [[ -f ~/.config/gtk-2.0/gtkrc ]] \
        && scp ~/.config/gtk-2.0/gtkrc ${xpra_host}:.config/gtk-2.0/gtkrc
    [[ -f ~/.config/gtk-3.0/settings.ini ]] \
        && scp ~/.config/gtk-3.0/settings.ini ${xpra_host}:.config/gtk-3.0/settings.ini

    if [[ -n "$GDK_SCALE" ]]; then
        app="env GDK_SCALE=${GDK_SCALE} GDK_DPI_SCALE=${GDK_DPI_SCALE:-1} ${app}"
    fi

    xpra start "${conn_str}" \
        --encoding=rgb \
        --title="@title@ on ${xpra_host}" \
        --tray=no \
        --notifications=no \
        --username=user \
        --start-child="${app}" \
        --start-via-proxy=no \
        --desktop-scaling=no
fi
